---

title: Title


keywords: fastai
sidebar: home_sidebar



nb_path: "notebooks/main-discord.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: notebooks/main-discord.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>[2023-04-27 17:43:24,901] [client.py:263] PyNaCl is not installed, voice will NOT be supported
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Parameters">Parameters<a class="anchor-link" href="#Parameters"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">biobot.constants</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">BOT_INVITE_URL</span><span class="p">,</span>
    <span class="n">DISCORD_BOT_TOKEN</span><span class="p">,</span>
    <span class="n">EXAMPLE_CONVOS</span><span class="p">,</span>
    <span class="n">ACTIVATE_THREAD_PREFX</span><span class="p">,</span>
    <span class="n">MAX_THREAD_MESSAGES</span><span class="p">,</span>
    <span class="n">SECONDS_DELAY_RECEIVING_MSG</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="GPT-Discord-Bot"><a href="https://github.com/openai/gpt-discord-bot">GPT Discord Bot</a><a class="anchor-link" href="#GPT-Discord-Bot"> </a></h2><h3 id="Demo">Demo<a class="anchor-link" href="#Demo"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered celltag_bash">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span>%%bash
git<span class="w"> </span>clone<span class="w"> </span>https://github.com/openai/gpt-discord-bot.git<span class="w"> </span>gpt-discord-bot_git
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Initialization">Initialization<a class="anchor-link" href="#Initialization"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_markdown rendered_html output_subarea ">
<h4 id="on_ready" class="doc_header"><code>on_ready</code><a href="https://github.com/seii-saintway/biobot/tree/master/biobot/discord.py#L53" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>on_ready</code>()</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nd">@client</span><span class="o">.</span><span class="n">event</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">on_ready</span><span class="p">():</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"We have logged in as </span><span class="si">{</span><span class="n">client</span><span class="o">.</span><span class="n">user</span><span class="si">}</span><span class="s2">. Invite URL: </span><span class="si">{</span><span class="n">BOT_INVITE_URL</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">completion</span><span class="o">.</span><span class="n">MY_BOT_NAME</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">name</span>
    <span class="n">completion</span><span class="o">.</span><span class="n">MY_BOT_EXAMPLE_CONVOS</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">EXAMPLE_CONVOS</span><span class="p">:</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">messages</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">user</span> <span class="o">==</span> <span class="s2">"Lenard"</span><span class="p">:</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Message</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">client</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">m</span><span class="o">.</span><span class="n">text</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="n">completion</span><span class="o">.</span><span class="n">MY_BOT_EXAMPLE_CONVOS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Conversation</span><span class="p">(</span><span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">))</span>
    <span class="k">await</span> <span class="n">tree</span><span class="o">.</span><span class="n">sync</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_markdown rendered_html output_subarea ">
<h4 id="Command object at 0x7fbd57b8fb80>" class="doc_header"><code>Command object at 0x7fbd57b8fb80></code><a href="" class="source_link" style="float:right">[source]</a></h4><p>A class that implements an application command.</p>
<p>These are usually not created manually, instead they are created using
one of the following decorators:</p>
<ul>
<li>:func:<code>~discord.app_commands.command</code></li>
<li>:meth:<code>Group.command &lt;discord.app_commands.Group.command&gt;</code></li>
<li>:meth:<code>CommandTree.command &lt;discord.app_commands.CommandTree.command&gt;</code></li>
</ul>
<p>.. versionadded:: 2.0</p>
<h2 id="Parameters">Parameters<a class="anchor-link" href="#Parameters"> </a></h2><p>name: Union[:class:<code>str</code>, :class:<code>locale_str</code>]
    The name of the application command.
description: Union[:class:<code>str</code>, :class:<code>locale_str</code>]
    The description of the application command. This shows up in the UI to describe
    the application command.
callback: :ref:<code>coroutine &lt;coroutine&gt;</code>
    The coroutine that is executed when the command is called.
auto_locale_strings: :class:<code>bool</code>
    If this is set to <code>True</code>, then all translatable strings will implicitly
    be wrapped into :class:<code>locale_str</code> rather than :class:<code>str</code>. This could
    avoid some repetition and be more ergonomic for certain defaults such
    as default command names, command descriptions, and parameter names.
    Defaults to <code>True</code>.
nsfw: :class:<code>bool</code>
    Whether the command is NSFW and should only work in NSFW channels.
    Defaults to <code>False</code>.</p>

<pre><code>Due to a Discord limitation, this does not work on subcommands.
</code></pre>
<p>parent: Optional[:class:<code>Group</code>]
    The parent application command. <code>None</code> if there isn't one.
extras: :class:<code>dict</code>
    A dictionary that can be used to store extraneous data.
    The library will not touch any values or keys within this dictionary.</p>
<h2 id="Attributes">Attributes<a class="anchor-link" href="#Attributes"> </a></h2><p>name: :class:<code>str</code>
    The name of the application command.
description: :class:<code>str</code>
    The description of the application command. This shows up in the UI to describe
    the application command.
checks
    A list of predicates that take a :class:<code>~discord.Interaction</code> parameter
    to indicate whether the command callback should be executed. If an exception
    is necessary to be thrown to signal failure, then one inherited from
    :exc:<code>AppCommandError</code> should be used. If all the checks fail without
    propagating an exception, :exc:<code>CheckFailure</code> is raised.
default_permissions: Optional[:class:<code>~discord.Permissions</code>]
    The default permissions that can execute this command on Discord. Note
    that server administrators can override this value in the client.
    Setting an empty permissions field will disallow anyone except server
    administrators from using the command in a guild.</p>

<pre><code>Due to a Discord limitation, this does not work on subcommands.
</code></pre>
<p>guild_only: :class:<code>bool</code>
    Whether the command should only be usable in guild contexts.</p>

<pre><code>Due to a Discord limitation, this does not work on subcommands.
</code></pre>
<p>nsfw: :class:<code>bool</code>
    Whether the command is NSFW and should only work in NSFW channels.</p>

<pre><code>Due to a Discord limitation, this does not work on subcommands.
</code></pre>
<p>parent: Optional[:class:<code>Group</code>]
    The parent application command. <code>None</code> if there isn't one.
extras: :class:<code>dict</code>
    A dictionary that can be used to store extraneous data.
    The library will not touch any values or keys within this dictionary.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># /chat message:</span>
<span class="nd">@tree</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"chat"</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">"Create a new thread for conversation"</span><span class="p">)</span>
<span class="nd">@discord</span><span class="o">.</span><span class="n">app_commands</span><span class="o">.</span><span class="n">checks</span><span class="o">.</span><span class="n">has_permissions</span><span class="p">(</span><span class="n">send_messages</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@discord</span><span class="o">.</span><span class="n">app_commands</span><span class="o">.</span><span class="n">checks</span><span class="o">.</span><span class="n">has_permissions</span><span class="p">(</span><span class="n">view_channel</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@discord</span><span class="o">.</span><span class="n">app_commands</span><span class="o">.</span><span class="n">checks</span><span class="o">.</span><span class="n">bot_has_permissions</span><span class="p">(</span><span class="n">send_messages</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@discord</span><span class="o">.</span><span class="n">app_commands</span><span class="o">.</span><span class="n">checks</span><span class="o">.</span><span class="n">bot_has_permissions</span><span class="p">(</span><span class="n">view_channel</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@discord</span><span class="o">.</span><span class="n">app_commands</span><span class="o">.</span><span class="n">checks</span><span class="o">.</span><span class="n">bot_has_permissions</span><span class="p">(</span><span class="n">manage_threads</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">chat_command</span><span class="p">(</span><span class="nb">int</span><span class="p">:</span> <span class="n">discord</span><span class="o">.</span><span class="n">Interaction</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># only support creating thread in text channel</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">int</span><span class="o">.</span><span class="n">channel</span><span class="p">,</span> <span class="n">discord</span><span class="o">.</span><span class="n">TextChannel</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="c1"># block servers not in allow list</span>
        <span class="k">if</span> <span class="n">should_block</span><span class="p">(</span><span class="n">guild</span><span class="o">=</span><span class="nb">int</span><span class="o">.</span><span class="n">guild</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="n">user</span> <span class="o">=</span> <span class="nb">int</span><span class="o">.</span><span class="n">user</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Chat command by </span><span class="si">{</span><span class="n">user</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">message</span><span class="p">[:</span><span class="mi">20</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># moderate the message</span>
            <span class="n">flagged_str</span><span class="p">,</span> <span class="n">blocked_str</span> <span class="o">=</span> <span class="n">moderate_message</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">send_moderation_blocked_message</span><span class="p">(</span>
                <span class="n">guild</span><span class="o">=</span><span class="nb">int</span><span class="o">.</span><span class="n">guild</span><span class="p">,</span>
                <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
                <span class="n">blocked_str</span><span class="o">=</span><span class="n">blocked_str</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">blocked_str</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># message was blocked</span>
                <span class="k">await</span> <span class="nb">int</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">"Your prompt has been blocked by moderation.</span><span class="se">\n</span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
                    <span class="n">ephemeral</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">return</span>

            <span class="n">embed</span> <span class="o">=</span> <span class="n">discord</span><span class="o">.</span><span class="n">Embed</span><span class="p">(</span>
                <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s2">"&lt;@</span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&gt; wants to chat! ü§ñüí¨"</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="n">discord</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">green</span><span class="p">(),</span>
            <span class="p">)</span>
            <span class="n">embed</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">message</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">flagged_str</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># message was flagged</span>
                <span class="n">embed</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">discord</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">yellow</span><span class="p">()</span>
                <span class="n">embed</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s2">"‚ö†Ô∏è This prompt was flagged by moderation."</span>

            <span class="k">await</span> <span class="nb">int</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">embed</span><span class="o">=</span><span class="n">embed</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="nb">int</span><span class="o">.</span><span class="n">original_response</span><span class="p">()</span>

            <span class="k">await</span> <span class="n">send_moderation_flagged_message</span><span class="p">(</span>
                <span class="n">guild</span><span class="o">=</span><span class="nb">int</span><span class="o">.</span><span class="n">guild</span><span class="p">,</span>
                <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
                <span class="n">flagged_str</span><span class="o">=</span><span class="n">flagged_str</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
                <span class="n">url</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">jump_url</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">await</span> <span class="nb">int</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">"Failed to start chat </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">ephemeral</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># create the thread</span>
        <span class="n">thread</span> <span class="o">=</span> <span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">create_thread</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">ACTIVATE_THREAD_PREFX</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">[:</span><span class="mi">20</span><span class="p">]</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">message</span><span class="p">[:</span><span class="mi">30</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
            <span class="n">slowmode_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">reason</span><span class="o">=</span><span class="s2">"gpt-bot"</span><span class="p">,</span>
            <span class="n">auto_archive_duration</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">thread</span><span class="o">.</span><span class="n">typing</span><span class="p">():</span>
            <span class="c1"># fetch completion</span>
            <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span><span class="n">Message</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">message</span><span class="p">)]</span>
            <span class="n">response_data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">generate_completion_response</span><span class="p">(</span>
                <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">user</span>
            <span class="p">)</span>
            <span class="c1"># send the result</span>
            <span class="k">await</span> <span class="n">process_response</span><span class="p">(</span>
                <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="n">thread</span><span class="o">=</span><span class="n">thread</span><span class="p">,</span> <span class="n">response_data</span><span class="o">=</span><span class="n">response_data</span>
            <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">await</span> <span class="nb">int</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">"Failed to start chat </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">ephemeral</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_markdown rendered_html output_subarea ">
<h4 id="on_message" class="doc_header"><code>on_message</code><a href="https://github.com/seii-saintway/biobot/tree/master/biobot/discord.py#L158" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>on_message</code>(<strong><code>message</code></strong>:<a href="/biobot/base.html#Message"><code>Message</code></a>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># calls for each message</span>
<span class="nd">@client</span><span class="o">.</span><span class="n">event</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">on_message</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="n">DiscordMessage</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># block servers not in allow list</span>
        <span class="k">if</span> <span class="n">should_block</span><span class="p">(</span><span class="n">guild</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">guild</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="c1"># ignore messages from the bot</span>
        <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">author</span> <span class="o">==</span> <span class="n">client</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># ignore messages not in a thread</span>
        <span class="n">channel</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">channel</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">discord</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="c1"># ignore threads not created by the bot</span>
        <span class="n">thread</span> <span class="o">=</span> <span class="n">channel</span>
        <span class="k">if</span> <span class="n">thread</span><span class="o">.</span><span class="n">owner_id</span> <span class="o">!=</span> <span class="n">client</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># ignore threads that are archived locked or title is not what we want</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">thread</span><span class="o">.</span><span class="n">archived</span>
            <span class="ow">or</span> <span class="n">thread</span><span class="o">.</span><span class="n">locked</span>
            <span class="ow">or</span> <span class="ow">not</span> <span class="n">thread</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">ACTIVATE_THREAD_PREFX</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="c1"># ignore this thread</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">thread</span><span class="o">.</span><span class="n">message_count</span> <span class="o">&gt;</span> <span class="n">MAX_THREAD_MESSAGES</span><span class="p">:</span>
            <span class="c1"># too many messages, no longer going to reply</span>
            <span class="k">await</span> <span class="n">close_thread</span><span class="p">(</span><span class="n">thread</span><span class="o">=</span><span class="n">thread</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># moderate the message</span>
        <span class="n">flagged_str</span><span class="p">,</span> <span class="n">blocked_str</span> <span class="o">=</span> <span class="n">moderate_message</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">author</span>
        <span class="p">)</span>
        <span class="k">await</span> <span class="n">send_moderation_blocked_message</span><span class="p">(</span>
            <span class="n">guild</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">guild</span><span class="p">,</span>
            <span class="n">user</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">author</span><span class="p">,</span>
            <span class="n">blocked_str</span><span class="o">=</span><span class="n">blocked_str</span><span class="p">,</span>
            <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">blocked_str</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
                <span class="k">await</span> <span class="n">thread</span><span class="o">.</span><span class="n">send</span><span class="p">(</span>
                    <span class="n">embed</span><span class="o">=</span><span class="n">discord</span><span class="o">.</span><span class="n">Embed</span><span class="p">(</span>
                        <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s2">"‚ùå **</span><span class="si">{</span><span class="n">message</span><span class="o">.</span><span class="n">author</span><span class="si">}</span><span class="s2">'s message has been deleted by moderation.**"</span><span class="p">,</span>
                        <span class="n">color</span><span class="o">=</span><span class="n">discord</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">red</span><span class="p">(),</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">return</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">thread</span><span class="o">.</span><span class="n">send</span><span class="p">(</span>
                    <span class="n">embed</span><span class="o">=</span><span class="n">discord</span><span class="o">.</span><span class="n">Embed</span><span class="p">(</span>
                        <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s2">"‚ùå **</span><span class="si">{</span><span class="n">message</span><span class="o">.</span><span class="n">author</span><span class="si">}</span><span class="s2">'s message has been blocked by moderation but could not be deleted. Missing Manage Messages permission in this Channel.**"</span><span class="p">,</span>
                        <span class="n">color</span><span class="o">=</span><span class="n">discord</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">red</span><span class="p">(),</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">return</span>
        <span class="k">await</span> <span class="n">send_moderation_flagged_message</span><span class="p">(</span>
            <span class="n">guild</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">guild</span><span class="p">,</span>
            <span class="n">user</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">author</span><span class="p">,</span>
            <span class="n">flagged_str</span><span class="o">=</span><span class="n">flagged_str</span><span class="p">,</span>
            <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">,</span>
            <span class="n">url</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">jump_url</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">flagged_str</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">thread</span><span class="o">.</span><span class="n">send</span><span class="p">(</span>
                <span class="n">embed</span><span class="o">=</span><span class="n">discord</span><span class="o">.</span><span class="n">Embed</span><span class="p">(</span>
                    <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s2">"‚ö†Ô∏è **</span><span class="si">{</span><span class="n">message</span><span class="o">.</span><span class="n">author</span><span class="si">}</span><span class="s2">'s message has been flagged by moderation.**"</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="n">discord</span><span class="o">.</span><span class="n">Color</span><span class="o">.</span><span class="n">yellow</span><span class="p">(),</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># wait a bit in case user has more messages</span>
        <span class="k">if</span> <span class="n">SECONDS_DELAY_RECEIVING_MSG</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">SECONDS_DELAY_RECEIVING_MSG</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">is_last_message_stale</span><span class="p">(</span>
                <span class="n">interaction_message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
                <span class="n">last_message</span><span class="o">=</span><span class="n">thread</span><span class="o">.</span><span class="n">last_message</span><span class="p">,</span>
                <span class="n">bot_id</span><span class="o">=</span><span class="n">client</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="c1"># there is another message, so ignore this one</span>
                <span class="k">return</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">"Thread message to process - </span><span class="si">{</span><span class="n">message</span><span class="o">.</span><span class="n">author</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">[:</span><span class="mi">50</span><span class="p">]</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">thread</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">thread</span><span class="o">.</span><span class="n">jump_url</span><span class="si">}</span><span class="s2">"</span>
        <span class="p">)</span>

        <span class="n">channel_messages</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">discord_message_to_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="k">async</span> <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">thread</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="n">MAX_THREAD_MESSAGES</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">channel_messages</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">channel_messages</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">channel_messages</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>

        <span class="c1"># generate the response</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">thread</span><span class="o">.</span><span class="n">typing</span><span class="p">():</span>
            <span class="n">response_data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">generate_completion_response</span><span class="p">(</span>
                <span class="n">messages</span><span class="o">=</span><span class="n">channel_messages</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">author</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">is_last_message_stale</span><span class="p">(</span>
            <span class="n">interaction_message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
            <span class="n">last_message</span><span class="o">=</span><span class="n">thread</span><span class="o">.</span><span class="n">last_message</span><span class="p">,</span>
            <span class="n">bot_id</span><span class="o">=</span><span class="n">client</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="c1"># there is another message and its not from us, so ignore this response</span>
            <span class="k">return</span>

        <span class="c1"># send response</span>
        <span class="k">await</span> <span class="n">process_response</span><span class="p">(</span>
            <span class="n">user</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">author</span><span class="p">,</span> <span class="n">thread</span><span class="o">=</span><span class="n">thread</span><span class="p">,</span> <span class="n">response_data</span><span class="o">=</span><span class="n">response_data</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Start-Chatting">Start Chatting<a class="anchor-link" href="#Start-Chatting"> </a></h2>
</div>
</div>
</div>
</div>


